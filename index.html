<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geotag Pro - Auto Filename & Address</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        #map { height: 350px; width: 100%; border-radius: 12px; z-index: 1; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen pb-10">

    <div class="max-w-6xl mx-auto px-4 py-8">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-black text-slate-800 tracking-tight">ðŸ“¸ GEOTAG PRO V1</h1>
            <p class="text-slate-500">Watermark Alamat Lengkap & Rename File Otomatis</p>
            <p class="text-slate-400">By Ery Rohmansyah</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <div class="lg:col-span-5 space-y-6">
                
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h2 class="font-bold text-slate-700 mb-4 flex items-center gap-2">
                        <span class="bg-blue-600 text-white w-6 h-6 flex items-center justify-center rounded-full text-xs">1</span>
                        Input Data & Foto
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs font-bold text-slate-400 uppercase">Pilih Gambar (JPEG/PNG)</label>
                            <input type="file" id="fileInput" multiple accept="image/*" class="w-full mt-1 text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        </div>
                        
                        <div>
                            <label class="text-xs font-bold text-slate-400 uppercase">Tanggal & Waktu Pengambilan</label>
                            <input type="datetime-local" id="dateInput" class="w-full mt-1 p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h2 class="font-bold text-slate-700 mb-4 flex items-center gap-2">
                        <span class="bg-blue-600 text-white w-6 h-6 flex items-center justify-center rounded-full text-xs">2</span>
                        Lokasi & Alamat
                    </h2>
                    
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="addressSearch" placeholder="Cari nama tempat/jalan..." class="flex-grow p-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-400 outline-none">
                        <button onclick="searchAddress()" class="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm hover:bg-black transition">Cari</button>
                    </div>

                    <div id="map" class="mb-4 border shadow-inner"></div>

                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <input type="text" id="lat" readonly placeholder="Lat" class="bg-slate-50 p-2 border rounded text-xs text-center font-mono">
                        <input type="text" id="lng" readonly placeholder="Lng" class="bg-slate-50 p-2 border rounded text-xs text-center font-mono">
                    </div>
                    
                    <label class="text-xs font-bold text-slate-400 uppercase">Alamat Lengkap</label>
                    <textarea id="fullAddress" rows="3" class="w-full mt-1 p-2 border rounded-lg text-xs bg-slate-50" placeholder="Klik pada peta untuk mendapatkan alamat..."></textarea>
                </div>

                <button onclick="processImages()" id="btnProcess" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-2xl shadow-lg transition-all flex justify-center items-center gap-3">
                    ðŸš€ PROSES & DOWNLOAD ZIP
                </button>
            </div>

            <div class="lg:col-span-7 space-y-4">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 min-h-[500px]">
                    <div class="flex justify-between items-center mb-6 border-b pb-4">
                        <h2 class="font-bold text-slate-700">Preview & Penamaan File</h2>
                        <span id="statusCount" class="text-xs font-bold bg-slate-100 text-slate-500 px-3 py-1 rounded-full uppercase">0 Files</span>
                    </div>
                    
                    <div id="previewList" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div class="col-span-full text-center py-20 text-slate-300">
                            <p class="text-4xl mb-2">ðŸ“¥</p>
                            <p>Belum ada gambar dipilih</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <script>
        // --- INISIALISASI PETA ---
        let map = L.map('map').setView([-6.2000, 106.8166], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        let marker = L.marker([-6.2000, 106.8166], {draggable: true}).addTo(map);

        // Default Tanggal (WIB)
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('dateInput').value = now.toISOString().slice(0, 16);

        // Update Lokasi & Alamat
        async function updateLocation(lat, lng) {
            marker.setLatLng([lat, lng]);
            document.getElementById('lat').value = lat.toFixed(6);
            document.getElementById('lng').value = lng.toFixed(6);
            
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                const data = await response.json();
                document.getElementById('fullAddress').value = data.display_name || "Alamat tidak ditemukan";
            } catch (err) {
                console.error("Gagal mengambil alamat");
            }
        }

        map.on('click', (e) => updateLocation(e.latlng.lat, e.latlng.lng));
        marker.on('dragend', () => updateLocation(marker.getLatLng().lat, marker.getLatLng().lng));

        function searchAddress() {
            let query = document.getElementById('addressSearch').value;
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
                .then(res => res.json())
                .then(data => {
                    if(data.length > 0) {
                        const pos = [parseFloat(data[0].lat), parseFloat(data[0].lon)];
                        map.setView(pos, 16);
                        updateLocation(pos[0], pos[1]);
                    }
                });
        }

        // --- PREVIEW HANDLER ---
        document.getElementById('fileInput').addEventListener('change', function() {
            const list = document.getElementById('previewList');
            const files = this.files;
            document.getElementById('statusCount').innerText = `${files.length} Files`;
            list.innerHTML = "";
            
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const div = document.createElement('div');
                    div.className = "bg-slate-50 p-2 rounded-lg border border-slate-200 text-center shadow-sm";
                    div.innerHTML = `<img src="${e.target.result}" class="w-full h-32 object-cover rounded mb-2">
                                     <p class="text-[10px] text-slate-500 truncate">${file.name}</p>`;
                    list.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        });

        // --- CORE PROCESSING ---
        async function processImages() {
            const files = document.getElementById('fileInput').files;
            const lat = document.getElementById('lat').value;
            const lng = document.getElementById('lng').value;
            const addr = document.getElementById('fullAddress').value;
            const rawDate = document.getElementById('dateInput').value; // 2023-10-27T14:30
            
            if (files.length === 0 || !lat) return alert("Lengkapi data foto dan lokasi!");

            const btn = document.getElementById('btnProcess');
            btn.innerText = "ðŸ”„ Sedang Memproses...";
            btn.disabled = true;

            const zip = new JSZip();
            
            // Format Penamaan File: YYYYMMDD_HHMMSS_Lat_Lng
            const datePart = rawDate.replace(/[-T:]/g, ''); 
            const coordPart = `${lat.replace('.', 'd')}_${lng.replace('.', 'd')}`;

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const processedImg = await drawWatermark(file, addr, lat, lng, rawDate.replace('T', ' '));
                
                // Nama File Baru
                const finalFileName = `${datePart}_${coordPart}_${i+1}.jpg`;
                
                const base64Content = processedImg.split(',')[1];
                zip.file(finalFileName, base64Content, {base64: true});
            }

            const content = await zip.generateAsync({type: "blob"});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(content);
            link.download = `GEOTAG_${datePart}.zip`;
            link.click();

            btn.innerText = "ðŸš€ PROSES & DOWNLOAD ZIP";
            btn.disabled = false;
        }

        function drawWatermark(file, address, lat, lng, date) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // Gunakan resolusi asli namun batasi max width untuk stabilitas
                        const MAX_WIDTH = 2500;
                        let width = img.width;
                        let height = img.height;

                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Style Watermark
                        const fontSize = Math.round(width * 0.022);
                        const padding = width * 0.02;
                        ctx.font = `bold ${fontSize}px sans-serif`;
                        
                        const lines = [
                            `WAKTU: ${date}`,
                            `LOKASI: ${lat}, ${lng}`,
                            `ALAMAT: ${address}`
                        ];

                        // Bungkus teks alamat agar tidak keluar layar
                        const wrappedAddress = wrapText(ctx, `ALAMAT: ${address}`, width - (padding * 2));
                        const finalLines = [lines[0], lines[1], ...wrappedAddress];

                        // Draw Background Box
                        const lineHeight = fontSize * 1.4;
                        const boxHeight = (finalLines.length * lineHeight) + (padding * 2);
                        
                        ctx.fillStyle = "rgba(0, 0, 0, 0.6)";
                        ctx.fillRect(0, height - boxHeight, width, boxHeight);
                        
                        // Draw Text
                        ctx.fillStyle = "white";
                        ctx.shadowColor = "black";
                        ctx.shadowBlur = 4;
                        
                        finalLines.forEach((line, idx) => {
                            ctx.fillText(line, padding, (height - boxHeight) + padding + (idx * lineHeight) + fontSize);
                        });
                        
                        resolve(canvas.toDataURL('image/jpeg', 0.85));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // Helper fungsi untuk memotong teks alamat jika terlalu panjang
        function wrapText(ctx, text, maxWidth) {
            const words = text.split(' ');
            const lines = [];
            let currentLine = words[0];

            for (let i = 1; i < words.length; i++) {
                const word = words[i];
                const width = ctx.measureText(currentLine + " " + word).width;
                if (width < maxWidth) {
                    currentLine += " " + word;
                } else {
                    lines.push(currentLine);
                    currentLine = word;
                }
            }
            lines.push(currentLine);
            return lines;
        }

        // Jalankan koordinat default
        updateLocation(-6.2000, 106.8166);
    </script>
</body>
</html>
