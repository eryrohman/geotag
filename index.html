<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geotag Pro Vq - Logo & Direct Download</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        #map { height: 300px; width: 100%; border-radius: 12px; z-index: 1; }
        .preview-card img { height: 100px; width: 100%; object-fit: cover; border-radius: 8px; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">

    <div class="max-w-6xl mx-auto px-4 py-8">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-black text-blue-800">üì∏ GEOTAG PRO V1</h1>
            <p class="text-slate-500">Logo Instansi + Penamaan Otomatis + Download Langsung</p> By Ery Rohmansyah
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <div class="lg:col-span-5 space-y-4">
                
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                    <h2 class="font-bold text-slate-700 mb-4 border-b pb-2">1. Upload Foto & Logo</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Pilih Foto (Bisa Banyak)</label>
                            <input type="file" id="fileInput" multiple accept="image/*" class="block w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-blue-50 file:text-blue-700">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-orange-500 uppercase">Upload Logo Instansi (Transparan PNG disarankan)</label>
                            <input type="file" id="logoInput" accept="image/*" class="block w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-orange-50 file:text-orange-700">
                        </div>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                    <h2 class="font-bold text-slate-700 mb-4 border-b pb-2">2. Pengaturan Geotag</h2>
                    <div class="space-y-3">
                        <input type="datetime-local" id="dateInput" class="w-full p-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        <div class="flex gap-1">
                            <input type="text" id="addressSearch" placeholder="Cari alamat..." class="flex-grow p-2 border rounded-lg text-sm">
                            <button onclick="searchAddress()" class="bg-slate-800 text-white px-3 py-1 rounded-lg text-xs">Cari</button>
                        </div>
                        <div id="map" class="border"></div>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <input type="text" id="lat" readonly class="bg-slate-100 p-2 border rounded font-mono text-center">
                            <input type="text" id="lng" readonly class="bg-slate-100 p-2 border rounded font-mono text-center">
                        </div>
                        <textarea id="fullAddress" rows="2" class="w-full p-2 border rounded-lg text-[11px] bg-slate-50" placeholder="Alamat otomatis..."></textarea>
                    </div>
                </div>

                <button onclick="processImages()" id="btnProcess" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-2xl shadow-lg transition-all flex justify-center items-center gap-2">
                    üì• PROSES & DOWNLOAD GAMBAR
                </button>
            </div>

            <div class="lg:col-span-7">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 min-h-[500px]">
                    <h2 class="font-bold text-slate-700 mb-4 flex justify-between">
                        <span>Antrian Proses</span>
                        <span id="statusCount" class="text-blue-600">0 Foto</span>
                    </h2>
                    <div id="previewList" class="grid grid-cols-2 sm:grid-cols-3 gap-4 border-t pt-4">
                        <p class="col-span-full text-center py-20 text-slate-300 italic">Pilih foto untuk melihat preview</p>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        let map = L.map('map').setView([-6.2000, 106.8166], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        let marker = L.marker([-6.2000, 106.8166], {draggable: true}).addTo(map);

        // Set waktu lokal sekarang
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('dateInput').value = now.toISOString().slice(0, 16);

        async function updateLocation(lat, lng) {
            marker.setLatLng([lat, lng]);
            document.getElementById('lat').value = lat.toFixed(6);
            document.getElementById('lng').value = lng.toFixed(6);
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                const data = await res.json();
                document.getElementById('fullAddress').value = data.display_name || "Alamat tidak ditemukan";
            } catch (err) {}
        }

        map.on('click', (e) => updateLocation(e.latlng.lat, e.latlng.lng));
        marker.on('dragend', () => updateLocation(marker.getLatLng().lat, marker.getLatLng().lng));

        function searchAddress() {
            let query = document.getElementById('addressSearch').value;
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
                .then(res => res.json())
                .then(data => {
                    if(data.length > 0) {
                        const pos = [parseFloat(data[0].lat), parseFloat(data[0].lon)];
                        map.setView(pos, 16);
                        updateLocation(pos[0], pos[1]);
                    }
                });
        }

        document.getElementById('fileInput').onchange = function() {
            const list = document.getElementById('previewList');
            const files = this.files;
            document.getElementById('statusCount').innerText = `${files.length} Foto`;
            list.innerHTML = "";
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const div = document.createElement('div');
                    div.className = "preview-card bg-slate-50 p-2 rounded shadow-sm border";
                    div.innerHTML = `<img src="${e.target.result}"><p class="text-[9px] mt-1 truncate">${file.name}</p>`;
                    list.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        };

        async function processImages() {
            const files = document.getElementById('fileInput').files;
            const logoFile = document.getElementById('logoInput').files[0];
            const lat = document.getElementById('lat').value;
            const lng = document.getElementById('lng').value;
            const addr = document.getElementById('fullAddress').value;
            const rawDate = document.getElementById('dateInput').value;
            
            if (files.length === 0 || !lat) return alert("Pilih foto dan lokasi!");

            const btn = document.getElementById('btnProcess');
            btn.innerText = "‚è≥ Memproses...";
            btn.disabled = true;

            // Load Logo if any
            let logoImg = null;
            if (logoFile) {
                logoImg = await loadImage(logoFile);
            }

            const datePart = rawDate.replace(/[-T:]/g, ''); 
            const coordPart = `${lat.replace('.', 'd')}_${lng.replace('.', 'd')}`;

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const processedDataUrl = await drawWatermark(file, logoImg, addr, lat, lng, rawDate.replace('T', ' '));
                
                // NAMA FILE BARU
                const finalFileName = `${datePart}_${coordPart}_${i+1}.jpg`;
                
                // DOWNLOAD LANGSUNG
                const link = document.createElement('a');
                link.href = processedDataUrl;
                link.download = finalFileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            btn.innerText = "üì• PROSES & DOWNLOAD GAMBAR";
            btn.disabled = false;
        }

        function loadImage(file) {
            return new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = e => {
                    const img = new Image();
                    img.onload = () => resolve(img);
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        function drawWatermark(file, logoImg, address, lat, lng, date) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // Set Resolusi (Batasi max width demi performa browser)
                        const scale = img.width > 2000 ? 2000 / img.width : 1;
                        canvas.width = img.width * scale;
                        canvas.height = img.height * scale;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        const w = canvas.width;
                        const h = canvas.height;
                        const fontSize = Math.round(w * 0.022);
                        const padding = w * 0.02;

                        // --- 1. GAMBAR LOGO (Pojok Kanan Atas) ---
                        if (logoImg) {
                            const logoWidth = w * 0.15; // Ukuran logo 15% dari lebar gambar
                            const logoHeight = (logoImg.height / logoImg.width) * logoWidth;
                            ctx.globalAlpha = 0.9;
                            ctx.drawImage(logoImg, w - logoWidth - padding, padding, logoWidth, logoHeight);
                            ctx.globalAlpha = 1.0;
                        }

                        // --- 2. TEXT WATERMARK (Pojok Kiri Bawah) ---
                        ctx.font = `bold ${fontSize}px sans-serif`;
                        const addrLines = wrapText(ctx, `ALAMAT: ${address}`, w - (padding * 2));
                        const allLines = [
                            `WAKTU: ${date}`,
                            `KOORDINAT: ${lat}, ${lng}`,
                            ...addrLines
                        ];

                        const lineH = fontSize * 1.3;
                        const boxH = (allLines.length * lineH) + (padding * 2);

                        // Box Hitam Transparan
                        ctx.fillStyle = "rgba(0, 0, 0, 0.5)";
                        ctx.fillRect(0, h - boxH, w, boxH);
                        
                        // Teks Putih
                        ctx.fillStyle = "white";
                        allLines.forEach((line, idx) => {
                            ctx.fillText(line, padding, (h - boxH) + padding + (idx * lineH) + fontSize);
                        });
                        
                        resolve(canvas.toDataURL('image/jpeg', 0.85));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        function wrapText(ctx, text, maxWidth) {
            const words = text.split(' ');
            const lines = [];
            let currentLine = words[0];
            for (let i = 1; i < words.length; i++) {
                if (ctx.measureText(currentLine + " " + words[i]).width < maxWidth) {
                    currentLine += " " + words[i];
                } else {
                    lines.push(currentLine);
                    currentLine = words[i];
                }
            }
            lines.push(currentLine);
            return lines;
        }

        updateLocation(-6.2000, 106.8166);
    </script>
</body>
</html>
