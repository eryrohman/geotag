<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geotag Pro V1</title>
    
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1042/1042339.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        #map { height: 280px; width: 100%; border-radius: 12px; z-index: 1; }
        .pwa-install-btn { display: none; } /* Hidden by default */
    </style>
</head>
<body class="bg-slate-50 min-h-screen">

    <div id="installBanner" class="hidden bg-blue-700 text-white p-4 flex justify-between items-center sticky top-0 z-[9999]">
        <span class="text-sm font-medium">Install Geotag Pro di HP Anda?</span>
        <button onclick="installPWA()" class="bg-white text-blue-700 px-4 py-1 rounded-full text-sm font-bold shadow-lg">Install</button>
    </div>

    <div class="max-w-6xl mx-auto px-4 py-6">
        <header class="mb-6 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-black text-blue-800">üì∏ GEOTAG PRo v1</h1>
                <p class="text-xs text-slate-500 italic">Offline Ready & Mobile Optimized by Ery Rohmansyah</p>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <div class="lg:col-span-5 space-y-4">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 space-y-4">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase">1. Upload Foto & Logo</label>
                        <input type="file" id="fileInput" multiple accept="image/*" class="block w-full text-xs text-slate-500 mt-1 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-blue-50 file:text-blue-700 font-semibold">
                        <input type="file" id="logoInput" accept="image/*" class="block w-full text-xs text-slate-500 mt-2 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-orange-50 file:text-orange-700 font-semibold">
                    </div>
                    
                    <div class="border-t pt-4">
                        <label class="text-[10px] font-bold text-slate-400 uppercase">2. Waktu & Lokasi</label>
                        <input type="datetime-local" id="dateInput" class="w-full mt-1 p-2 border rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-500">
                        
                        <div class="flex gap-1 mt-2">
                            <input type="text" id="addressSearch" placeholder="Cari alamat..." class="flex-grow p-2 border rounded-lg text-sm">
                            <button onclick="searchAddress()" class="bg-slate-800 text-white px-3 rounded-lg text-xs">Cari</button>
                        </div>
                        
                        <div id="map" class="mt-2 border"></div>
                        
                        <div class="grid grid-cols-2 gap-2 mt-2">
                            <input type="text" id="lat" readonly class="bg-slate-100 p-2 border rounded text-[10px] font-mono text-center">
                            <input type="text" id="lng" readonly class="bg-slate-100 p-2 border rounded text-[10px] font-mono text-center">
                        </div>
                        <textarea id="fullAddress" rows="2" class="w-full mt-2 p-2 border rounded-lg text-[10px] bg-slate-50" placeholder="Alamat otomatis..."></textarea>
                    </div>
                </div>

                <button onclick="processImages()" id="btnProcess" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-2xl shadow-lg transition-all active:scale-95">
                    üì• PROSES & DOWNLOAD
                </button>
            </div>

            <div class="lg:col-span-7">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 min-h-[400px]">
                    <h2 class="font-bold text-slate-700 mb-4 border-b pb-2 flex justify-between">
                        <span>Antrian Foto</span>
                        <span id="statusCount" class="text-blue-600 text-sm">0 Items</span>
                    </h2>
                    <div id="previewList" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                        <p class="col-span-full text-center py-20 text-slate-300 italic text-sm">Belum ada foto yang dipilih</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- PWA SETUP (MANIFEST & SERVICE WORKER) ---
        const manifest = {
            "name": "Geotag Pro Master",
            "short_name": "GeotagPro",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#ffffff",
            "theme_color": "#2563eb",
            "icons": [{
                "src": "https://cdn-icons-png.flaticon.com/512/1042/1042339.png",
                "sizes": "512x512",
                "type": "image/png"
            }]
        };

        const manifestStr = JSON.stringify(manifest);
        const blob = new Blob([manifestStr], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(blob);
        document.querySelector('head').insertAdjacentHTML('beforeend', `<link rel="manifest" href="${manifestURL}">`);

        // Register Service Worker for Offline access
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swCode = `
                    self.addEventListener('install', e => self.skipWaiting());
                    self.addEventListener('fetch', e => e.respondWith(fetch(e.request).catch(() => caches.match(e.request))));
                `;
                const swBlob = new Blob([swCode], {type: 'text/javascript'});
                const swUrl = URL.createObjectURL(swBlob);
                navigator.serviceWorker.register(swUrl);
            });
        }

        // Install Logic
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installBanner').classList.remove('hidden');
        });

        async function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    document.getElementById('installBanner').classList.add('hidden');
                }
                deferredPrompt = null;
            }
        }

        // --- CORE GEOTAG LOGIC ---
        let map = L.map('map').setView([-6.2000, 106.8166], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        let marker = L.marker([-6.2000, 106.8166], {draggable: true}).addTo(map);

        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('dateInput').value = now.toISOString().slice(0, 16);

        async function updateLocation(lat, lng) {
            marker.setLatLng([lat, lng]);
            document.getElementById('lat').value = lat.toFixed(6);
            document.getElementById('lng').value = lng.toFixed(6);
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                const data = await res.json();
                document.getElementById('fullAddress').value = data.display_name || "Alamat tidak ditemukan";
            } catch (err) {}
        }

        map.on('click', (e) => updateLocation(e.latlng.lat, e.latlng.lng));
        marker.on('dragend', () => updateLocation(marker.getLatLng().lat, marker.getLatLng().lng));

        function searchAddress() {
            let query = document.getElementById('addressSearch').value;
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
                .then(res => res.json())
                .then(data => {
                    if(data.length > 0) {
                        const pos = [parseFloat(data[0].lat), parseFloat(data[0].lon)];
                        map.setView(pos, 16);
                        updateLocation(pos[0], pos[1]);
                    }
                });
        }

        document.getElementById('fileInput').onchange = function() {
            const list = document.getElementById('previewList');
            const files = this.files;
            document.getElementById('statusCount').innerText = `${files.length} Foto`;
            list.innerHTML = "";
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const div = document.createElement('div');
                    div.className = "bg-slate-100 p-1 rounded border";
                    div.innerHTML = `<img src="${e.target.result}" class="w-full h-24 object-cover rounded">`;
                    list.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        };

        async function processImages() {
            const files = document.getElementById('fileInput').files;
            const logoFile = document.getElementById('logoInput').files[0];
            const lat = document.getElementById('lat').value;
            const lng = document.getElementById('lng').value;
            const addr = document.getElementById('fullAddress').value;
            const rawDate = document.getElementById('dateInput').value;
            
            if (files.length === 0 || !lat) return alert("Pilih foto & lokasi!");

            const btn = document.getElementById('btnProcess');
            btn.innerText = "‚è≥ Sedang Memproses...";
            btn.disabled = true;

            let logoImg = logoFile ? await loadImage(logoFile) : null;
            const datePart = rawDate.replace(/[-T:]/g, ''); 
            const coordPart = `${lat.replace('.', 'd')}_${lng.replace('.', 'd')}`;

            for (let i = 0; i < files.length; i++) {
                const dataUrl = await drawWatermark(files[i], logoImg, addr, lat, lng, rawDate.replace('T', ' '));
                const link = document.createElement('a');
                link.href = dataUrl;
                link.download = `${datePart}_${coordPart}_${i+1}.jpg`;
                link.click();
            }

            btn.innerText = "üì• PROSES & DOWNLOAD";
            btn.disabled = false;
        }

        function loadImage(file) {
            return new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = e => {
                    const img = new Image();
                    img.onload = () => resolve(img);
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        function drawWatermark(file, logoImg, address, lat, lng, date) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const scale = img.width > 1800 ? 1800 / img.width : 1;
                        canvas.width = img.width * scale;
                        canvas.height = img.height * scale;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        const w = canvas.width;
                        const h = canvas.height;
                        const fontSize = Math.round(w * 0.025);
                        const padding = w * 0.03;

                        // Logo (Kanan Atas)
                        if (logoImg) {
                            const lW = w * 0.15;
                            const lH = (logoImg.height / logoImg.width) * lW;
                            ctx.drawImage(logoImg, w - lW - padding, padding, lW, lH);
                        }

                        // Text Logic
                        ctx.font = `bold ${fontSize}px Arial`;
                        const addrLines = wrapText(ctx, `ALAMAT: ${address}`, w - (padding * 2));
                        const lines = [`WAKTU: ${date}`, `GPS: ${lat}, ${lng}`, ...addrLines];
                        
                        const lineH = fontSize * 1.3;
                        const boxH = (lines.length * lineH) + (padding * 2);

                        ctx.fillStyle = "rgba(0, 0, 0, 0.5)";
                        ctx.fillRect(0, h - boxH, w, boxH);
                        
                        ctx.fillStyle = "white";
                        lines.forEach((l, idx) => {
                            ctx.fillText(l, padding, (h - boxH) + padding + (idx * lineH) + fontSize);
                        });
                        
                        resolve(canvas.toDataURL('image/jpeg', 0.8));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        function wrapText(ctx, text, maxWidth) {
            const words = text.split(' ');
            const lines = [];
            let currentLine = words[0];
            for (let i = 1; i < words.length; i++) {
                if (ctx.measureText(currentLine + " " + words[i]).width < maxWidth) {
                    currentLine += " " + words[i];
                } else {
                    lines.push(currentLine);
                    currentLine = words[i];
                }
            }
            lines.push(currentLine);
            return lines;
        }

        updateLocation(-6.2000, 106.8166);
    </script>
</body>
</html>
